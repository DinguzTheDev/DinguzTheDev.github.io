<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YTDL Hybrid</title>
    <style>
        :root {
            --bg: #09090b; --card: #18181b; --primary: #3b82f6; --text: #fff;
        }
        body {
            background: var(--bg); color: var(--text); display: flex; 
            justify-content: center; align-items: center; min-height: 100vh; font-family: sans-serif; margin: 0;
            overflow: hidden;
        }
        /* Glow tła */
        body::before {
            content: ''; position: absolute; width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            z-index: -1; animation: pulse 10s infinite alternate;
        }
        @keyframes pulse { 0% {transform:scale(1);} 100% {transform:scale(1.1);} }

        .container { width: 100%; max-width: 500px; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        /* Input Group */
        .input-group {
            background: var(--card); border-radius: 30px; padding: 5px; display: flex; align-items: center;
            border: 1px solid rgba(255,255,255,0.05); transition: 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .input-group:focus-within { border-color: var(--primary); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }

        input {
            flex: 1; background: transparent; border: none; outline: none; color: #fff; padding: 15px 20px; font-size: 16px;
        }

        /* Download Button z PNG */
        .dl-btn {
            background: var(--primary); border: none; width: 48px; height: 48px; border-radius: 50%;
            cursor: pointer; margin-right: 2px; transition: 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .dl-btn:hover { transform: scale(1.1); box-shadow: 0 0 15px var(--primary); }
        .dl-btn img { width: 24px; height: 24px; object-fit: contain; }
        
        /* Dropdown */
        .dropdown { position: relative; z-index: 10; }
        .dd-head {
            background: var(--card); border-radius: 20px; padding: 12px 20px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); font-size: 14px; color: #aaa;
        }
        .dd-menu {
            position: absolute; top: 110%; left: 0; width: 100%; background: #121214; border-radius: 15px;
            overflow: hidden; opacity: 0; visibility: hidden; transition: 0.2s; transform: translateY(-10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .dd-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .opt { padding: 12px 20px; cursor: pointer; color: #aaa; font-size: 14px; transition: 0.2s; }
        .opt:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .opt.selected { color: var(--primary); background: rgba(59, 130, 246, 0.1); }

        .status { text-align: center; font-size: 13px; margin-top: 10px; opacity: 0; transition: 0.3s; color: #aaa;}
    </style>
</head>
<body>

<div class="container">
    <div class="input-group">
        <input type="text" id="url" placeholder="Wklej link YouTube..." autocomplete="off">
        <button class="dl-btn" id="btn">
            <img src="https://cdn-icons-png.flaticon.com/512/724/724933.png" style="filter: invert(1);" alt="DL">
        </button>
    </div>

    <div class="dropdown">
        <div class="dd-head" id="ddTrig"><span>MP4 (Auto Best)</span> <span>▼</span></div>
        <div class="dd-menu" id="ddMenu">
            <div class="opt selected" data-val="mp4_best">MP4 (Auto Best)</div>
            <div class="opt" data-val="mp4_1080">MP4 (1080p)</div>
            <div class="opt" data-val="mp3">Audio (MP3)</div>
            <div class="opt" data-val="wav">Audio (WAV)</div>
        </div>
    </div>
    <div class="status" id="status">Gotowe</div>
</div>

<script>
    // --- Logic UI ---
    let format = 'mp4_best';
    const trig = document.getElementById('ddTrig');
    const menu = document.getElementById('ddMenu');
    const status = document.getElementById('status');
    const input = document.getElementById('url');
    const btn = document.getElementById('btn');

    trig.onclick = (e) => { e.stopPropagation(); menu.classList.toggle('show'); };
    document.querySelectorAll('.opt').forEach(o => o.onclick = () => {
        document.querySelectorAll('.opt').forEach(x => x.classList.remove('selected'));
        o.classList.add('selected');
        trig.firstElementChild.innerText = o.innerText;
        format = o.dataset.val;
    });
    window.onclick = () => menu.classList.remove('show');

    // --- Logic Hybrid Download ---
    btn.onclick = async () => {
        if(!input.value) return;
        const oldIcon = btn.innerHTML;
        // Spinner SVG
        btn.innerHTML = `<svg viewBox="0 0 24 24" style="width:20px;animation:s 1s linear infinite" stroke="#fff" fill="none" stroke-width="3"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg>`;
        const s = document.createElement("style"); s.innerText="@keyframes s{to{transform:rotate(360deg)}}"; document.head.append(s);

        status.style.opacity = 1; status.innerText = "Szukanie serwera lokalnego...";

        try {
            // 1. Próba Lokalna
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 1500); // 1.5s timeout
            
            const res = await fetch('http://127.0.0.1:5000/download', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({url: input.value, format: format}),
                signal: controller.signal
            });
            const json = await res.json();
            if(json.status === 'error') throw new Error(json.message);
            
            status.innerText = "Pobrano na dysk (Lokalnie)!";
            status.style.color = "#4ade80";

        } catch (e) {
            // 2. Fallback Cobalt
            status.innerText = "Tryb Online (Cobalt)...";
            status.style.color = "#60a5fa";
            
            try {
                let req = { url: input.value, vQuality: "max", isAudioOnly: false };
                if(format === 'mp3') { req.isAudioOnly = true; req.aFormat = "mp3"; }
                if(format === 'mp4_1080') req.vQuality = "1080";

                const cRes = await fetch('https://api.cobalt.tools/api/json', {
                    method: 'POST', headers: {'Accept':'application/json','Content-Type':'application/json'},
                    body: JSON.stringify(req)
                });
                const cJson = await cRes.json();
                if(cJson.url) {
                    const a = document.createElement('a'); a.href = cJson.url; a.download = ''; 
                    document.body.append(a); a.click(); a.remove();
                    status.innerText = "Pobieranie rozpoczęte!"; status.style.color = "#4ade80";
                } else { throw new Error("Błąd API"); }
            } catch (err) {
                status.innerText = "Błąd pobierania."; status.style.color = "#ef4444";
            }
        }
        
        setTimeout(() => { 
            btn.innerHTML = oldIcon; 
            if(status.innerText.includes("Pobrano") || status.innerText.includes("rozpoczęte")) {
                input.value = ""; setTimeout(()=>status.style.opacity=0, 2000); status.style.color="#aaa";
            }
        }, 2000);
    };
</script>
</body>
</html>
